<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buen Camino - Ê≥ïÂúã‰πãË∑ØÂä©Êâã</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Leaflet CSS & JS (Âú∞Âúñ) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- FontAwesome (ÂúñÊ®ô) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6;
        }
        
        /* Èö±Ëóè Scrollbar ‰ΩÜ‰øùÊåÅÊªëÂãïÂäüËÉΩ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Âú∞ÂúñÂÆπÂô® */
        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }

        /* Ê®°Êì¨ App ËΩâÂ†¥ÊïàÊûú */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.2s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }

        /* Camino Yellow */
        .text-camino { color: #f59e0b; }
        .bg-camino { background-color: #f59e0b; }
        .border-camino { border-color: #f59e0b; }

        /* Ëá™ÂÆöÁæ© Popup Ê®£Âºè */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
        }
        .leaflet-popup-content {
            margin: 0;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden">

    <div id="app" class="h-full flex flex-col relative max-w-md mx-auto bg-white shadow-2xl overflow-hidden">
        
        <!-- Top Bar (Header) -->
        <header class="bg-blue-600 text-white p-4 shadow-md z-20 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-shell text-yellow-300 text-2xl"></i>
                <div class="flex flex-col items-start">
                    <h1 class="text-lg font-bold leading-tight">Buen Camino</h1>
                    <p class="text-xs text-blue-100">{{ currentStageName || 'Ê∫ñÂÇôÂá∫Áôº' }}</p>
                </div>
            </div>
            <button @click="showSyncStatus" class="text-white hover:text-yellow-300 transition">
                <i class="fa-solid fa-cloud-arrow-down"></i>
            </button>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow overflow-y-auto hide-scrollbar relative bg-gray-50">
            
            <!-- VIEW: DASHBOARD -->
            <div v-if="currentView === 'dashboard'" class="p-4 space-y-4 pb-32">
                
                <!-- Weather Forecast & Clothing Advice Widget (Collapsible) -->
                <div class="bg-gradient-to-br from-blue-600 to-blue-400 rounded-2xl text-white shadow-lg relative overflow-hidden transition-all duration-300"
                     :class="isWeatherExpanded ? 'p-5' : 'p-4'">
                    <!-- Background Decor -->
                    <div class="absolute right-0 top-0 opacity-10 transform translate-x-8 -translate-y-8">
                        <i class="fa-solid fa-sun text-9xl"></i>
                    </div>
                    
                    <div class="relative z-10">
                        <!-- Header / Main Display -->
                        <div class="flex justify-between items-start" @click="isWeatherExpanded = !isWeatherExpanded">
                            <div class="cursor-pointer">
                                <p class="text-xs opacity-90 flex items-center gap-1 mb-1"><i class="fa-solid fa-location-dot"></i> Pamplona (‰ªäÊó•)</p>
                                <div class="flex items-center gap-3">
                                    <h2 class="text-5xl font-bold tracking-tighter transition-all duration-300" :class="isWeatherExpanded ? 'text-5xl' : 'text-3xl'">22¬∞</h2>
                                    <div class="text-sm opacity-90">
                                        <p class="font-semibold text-lg leading-tight">Â§öÈõ≤ÊôÇÊô¥</p>
                                        <p class="text-xs" v-if="isWeatherExpanded">H:23¬∞ L:14¬∞</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Toggle Button & Mini Stats -->
                            <div class="flex flex-col items-end">
                                <button class="text-white/80 hover:text-white p-1 mb-2">
                                    <i class="fa-solid transition-transform duration-300" :class="isWeatherExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                </button>
                                
                                <div v-if="isWeatherExpanded" class="text-right text-sm font-medium flex flex-col items-end gap-1">
                                    <div class="bg-white/20 backdrop-blur-sm px-2 py-1 rounded text-xs flex items-center gap-1">
                                        <i class="fa-solid fa-droplet"></i> 10%
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm px-2 py-1 rounded text-xs flex items-center gap-1">
                                        <i class="fa-solid fa-wind"></i> 12km/h
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Expanded Content -->
                        <div v-if="isWeatherExpanded" class="mt-4 transition-all duration-300 ease-in-out">
                            <!-- Clothing Advice -->
                            <div class="bg-white/20 backdrop-blur-md rounded-xl p-3 mb-5 flex items-start gap-3 border border-white/10">
                                <div class="bg-yellow-400/20 w-8 h-8 rounded-full flex items-center justify-center shrink-0 text-yellow-300 border border-yellow-200/30">
                                    <i class="fa-solid fa-shirt text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-[10px] font-bold text-blue-50 opacity-80 uppercase tracking-wider mb-0.5">‰ªäÊó•Á©øÊê≠Âª∫Ë≠∞</p>
                                    <p class="text-sm font-medium leading-snug">{{ clothingAdvice }}</p>
                                </div>
                            </div>

                            <!-- Hourly Forecast (Horizontal Scroll) -->
                            <div class="border-t border-white/10 pt-3">
                                <div class="flex gap-5 overflow-x-auto pb-2 hide-scrollbar">
                                    <div v-for="(hour, idx) in hourlyForecast" :key="idx" class="flex flex-col items-center gap-1 min-w-[2.5rem]">
                                        <span class="text-[10px] opacity-80">{{ hour.time }}</span>
                                        <i class="fa-solid text-lg my-1" :class="[hour.icon, idx === 2 ? 'text-yellow-300' : 'text-white']"></i>
                                        <span class="text-sm font-bold">{{ hour.temp }}¬∞</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Card -->
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-700 mb-3">ÊúùËÅñÈÄ≤Â∫¶</h3>
                    <div class="flex items-center gap-4">
                        <div class="relative w-16 h-16 flex items-center justify-center rounded-full border-4 border-yellow-400 text-yellow-600 font-bold text-sm">
                            {{ progressPercentage }}%
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-500">Â∑≤ÂÆåÊàê</span>
                                <span class="font-bold">{{ completedKm.toFixed(1) }} km</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">Ââ©È§ò</span>
                                <span class="font-bold text-blue-600">{{ remainingKm }} km</span>
                            </div>
                            <div class="text-xs text-gray-400 mt-2">Ê≥ïÂúã‰πãË∑ØÁ∏ΩÈï∑Á¥Ñ 779 km</div>
                        </div>
                    </div>
                </div>

                <!-- Next Stop Recommendation (Dynamic) -->
                <div v-if="nextRecommendedAlbergue" class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 transition" @click="showPoiOnMap(nextRecommendedAlbergue)">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700">‰∏ã‰∏ÄÁ´ôÊé®Ëñ¶</h3>
                        <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">
                            {{ nextRecommendedAlbergue.category === 'Xunta' ? 'ÂÖ¨Á´ã (Xunta)' : nextRecommendedAlbergue.category }}
                        </span>
                    </div>
                    <div class="flex gap-3">
                        <div class="w-20 h-20 rounded-full bg-blue-100 flex items-center justify-center shrink-0 text-blue-500">
                            <i class="fa-solid fa-bed text-3xl"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold truncate text-gray-800">{{ nextRecommendedAlbergue.name }}</h4>
                            <p class="text-xs text-gray-500 line-clamp-2 mt-1">{{ nextRecommendedAlbergue.description }}</p>
                            <div class="mt-2 flex items-center gap-3 text-xs">
                                <span class="text-yellow-500 font-medium"><i class="fa-solid fa-star"></i> Êé®Ëñ¶</span>
                                <span class="text-gray-300">|</span>
                                <span class="text-blue-600 font-medium">{{ nextRecommendedAlbergue.price }}</span>
                                <span class="text-gray-300">|</span>
                                <span class="text-gray-500">{{ nextRecommendedAlbergue.beds }} Â∫ä</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex items-center justify-center text-gray-400 text-sm">
                    ÊÅ≠ÂñúÔºÅÊÇ®Â∑≤ÂÆåÊàêÊâÄÊúâË°åÁ®ã„ÄÇ
                </div>
            </div>

            <!-- VIEW: MAP -->
            <div v-show="currentView === 'map'" class="h-full relative w-full">
                <div id="map" class="w-full h-full"></div>
                
                <!-- Map Controls Overlay -->
                <div class="absolute top-4 right-4 z-[400] flex flex-col gap-2">
                    <button @click="locateUser" class="bg-white w-10 h-10 rounded-full shadow-md flex items-center justify-center text-blue-600 active:bg-gray-100">
                        <i class="fa-solid fa-location-crosshairs"></i>
                    </button>
                    <!-- Êñ∞Â¢ûÔºöÂÖ®Ë¶ΩË∑ØÁ∑öÊåâÈàï -->
                    <button @click="fitRoute" class="bg-white w-10 h-10 rounded-full shadow-md flex items-center justify-center text-yellow-500 active:bg-gray-100">
                        <i class="fa-solid fa-route"></i>
                    </button>
                    <button @click="downloadOfflineMap" class="bg-white w-10 h-10 rounded-full shadow-md flex items-center justify-center text-gray-600 active:bg-gray-100">
                        <i class="fa-solid fa-download"></i>
                    </button>
                </div>

                <!-- Filter Chips -->
                <div class="absolute top-4 left-4 z-[400] flex gap-2 overflow-x-auto max-w-[70%] hide-scrollbar">
                    <button @click="toggleMapFilter('albergue')" :class="filters.albergue ? 'bg-blue-600 text-white' : 'bg-white text-gray-600'" class="px-3 py-1.5 rounded-full text-xs font-medium shadow-md whitespace-nowrap transition">
                        <i class="fa-solid fa-bed mr-1"></i> ‰ΩèÂÆø
                    </button>
                    <button @click="toggleMapFilter('sight')" :class="filters.sight ? 'bg-purple-600 text-white' : 'bg-white text-gray-600'" class="px-3 py-1.5 rounded-full text-xs font-medium shadow-md whitespace-nowrap transition">
                        <i class="fa-solid fa-camera mr-1"></i> ÊôØÈªû
                    </button>
                    <button @click="toggleMapFilter('food')" :class="filters.food ? 'bg-green-600 text-white' : 'bg-white text-gray-600'" class="px-3 py-1.5 rounded-full text-xs font-medium shadow-md whitespace-nowrap transition">
                        <i class="fa-solid fa-utensils mr-1"></i> È§êÈ£≤
                    </button>
                    <button @click="toggleMapFilter('water')" :class="filters.water ? 'bg-blue-400 text-white' : 'bg-white text-gray-600'" class="px-3 py-1.5 rounded-full text-xs font-medium shadow-md whitespace-nowrap transition">
                        <i class="fa-solid fa-faucet mr-1"></i> Ê∞¥Ê∫ê
                    </button>
                </div>

                <!-- POI Detail Card (Popup replacement) -->
                <transition name="fade">
                    <div v-if="selectedPOI" class="absolute bottom-4 left-4 right-4 bg-white rounded-xl shadow-2xl p-4 z-[401] border-l-4 border-yellow-400 max-h-[60vh] overflow-y-auto">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">{{ selectedPOI.name }}</h3>
                                <!-- È°ûÂà•Ê®ôÁ±§ -->
                                <div class="flex items-center gap-2 mt-1 mb-1">
                                    <span v-if="selectedPOI.category" class="text-xs px-2 py-0.5 rounded font-medium"
                                          :class="{
                                              'bg-green-100 text-green-700': selectedPOI.category === 'ÂÖ¨Á´ã' || selectedPOI.category === 'Xunta',
                                              'bg-purple-100 text-purple-700': selectedPOI.category === 'ÁßÅÁ´ã',
                                              'bg-yellow-100 text-yellow-700': selectedPOI.category === 'ÊïôÊúÉ'
                                          }">
                                        {{ selectedPOI.category === 'Xunta' ? 'ÂÖ¨Á´ã (Xunta)' : selectedPOI.category }}
                                    </span>
                                    <div class="text-xs text-gray-500 capitalize">{{ getPoiTypeLabel(selectedPOI.type) }}</div>
                                </div>
                            </div>
                            <button @click="selectedPOI = null" class="text-gray-400 p-1"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        
                        <div v-if="selectedPOI.type === 'albergue'" class="mt-2 text-sm space-y-2">
                            <!-- Basic Info -->
                            <div class="flex items-center gap-4 text-gray-700">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-euro-sign w-4 text-center text-blue-500"></i> 
                                    <span class="font-semibold">{{ selectedPOI.price }}</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-bed w-4 text-center text-blue-500"></i> 
                                    <span>{{ selectedPOI.beds }} Â∫ä‰Ωç</span>
                                </div>
                            </div>
                            
                            <!-- Phone -->
                            <div class="flex items-center gap-2 text-gray-600">
                                <i class="fa-solid fa-phone w-4 text-center text-gray-400"></i> {{ selectedPOI.phone }}
                            </div>

                            <!-- Facilities -->
                            <div class="flex flex-wrap gap-1 mt-2">
                                <span v-for="fac in selectedPOI.facilities" :key="fac" class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600 flex items-center gap-1">
                                    <i v-if="fac === 'kitchen'" class="fa-solid fa-fire-burner"></i>
                                    <i v-if="fac === 'laundry'" class="fa-solid fa-jug-detergent"></i>
                                    <i v-if="fac === 'wifi'" class="fa-solid fa-wifi"></i>
                                    <i v-if="fac === 'pool'" class="fa-solid fa-person-swimming"></i>
                                    <i v-if="fac === 'bar'" class="fa-solid fa-beer-mug-empty"></i>
                                    <i v-if="fac === 'dinner'" class="fa-solid fa-utensils"></i>
                                    <i v-if="fac === 'garden'" class="fa-solid fa-tree"></i>
                                    <i v-if="fac === 'hot_water'" class="fa-solid fa-shower"></i>
                                    <i v-if="fac === 'single_rooms'" class="fa-solid fa-door-closed"></i>
                                    {{ getFacilityName(fac) }}
                                </span>
                            </div>

                            <!-- Description -->
                            <p class="text-gray-600 text-xs leading-relaxed border-t border-gray-100 pt-2 mt-2">
                                {{ selectedPOI.description }}
                            </p>

                            <!-- Landmarks -->
                            <div v-if="selectedPOI.landmarks" class="bg-yellow-50 p-2 rounded-lg border border-yellow-100 mt-2">
                                <div class="flex items-start gap-2">
                                    <i class="fa-solid fa-map-pin text-yellow-600 mt-0.5 text-xs"></i>
                                    <div>
                                        <span class="text-xs font-bold text-yellow-800 block">ÈôÑËøëÊôØÈªûÔºö</span>
                                        <span class="text-xs text-yellow-900">{{ selectedPOI.landmarks }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-else class="mt-2 text-sm text-gray-600">
                            {{ selectedPOI.description }}
                        </div>
                        <button class="w-full mt-3 bg-blue-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition">Â∞éËà™Ëá≥Ê≠§</button>
                    </div>
                </transition>
            </div>

            <!-- VIEW: STAGES -->
            <div v-if="currentView === 'stages'" class="p-4 space-y-3 pb-32">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="font-bold text-xl">20 Â§©Êà∞Áï•Ë¶èÂäÉ</h2>
                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Ê≠•Ë°åÁ∏ΩË®à {{ totalKm.toFixed(1) }} km</span>
                </div>

                <div v-for="(stage, index) in stages" :key="index" 
                     class="bg-white rounded-xl p-4 shadow-sm border transition-all duration-200"
                     :class="[
                        stage.completed ? 'border-green-200 bg-green-50 opacity-75' : 'border-gray-100',
                        stage.type === 'bus' ? 'border-l-4 border-l-blue-400' : '',
                        stage.type === 'rest' ? 'border-l-4 border-l-purple-400' : ''
                     ]">
                    <div class="flex items-center gap-3">
                        <div @click="toggleStage(index)" class="cursor-pointer">
                            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors"
                                 :class="stage.completed ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-transparent'">
                                <i class="fa-solid fa-check text-xs"></i>
                            </div>
                        </div>
                        <div class="flex-1" @click="expandStage(index)">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <h3 class="font-bold text-gray-800" :class="{'line-through text-gray-500': stage.completed}">Day {{ index + 1 }}</h3>
                                    <span v-if="stage.type === 'bus'" class="text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded"><i class="fa-solid fa-bus"></i> Â∑¥Â£´ÁßªÂãï</span>
                                    <span v-if="stage.type === 'rest'" class="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded"><i class="fa-solid fa-mug-hot"></i> ‰ºëÊÅØÊó•</span>
                                </div>
                                <span class="text-sm font-medium text-blue-600">{{ stage.km }} km</span>
                            </div>
                            <div class="text-sm text-gray-500 flex justify-between mt-1">
                                <span>
                                    <span v-if="stage.from">{{ stage.from }}</span>
                                    <i v-if="stage.to" class="fa-solid fa-arrow-right text-xs mx-1"></i>
                                    {{ stage.to || 'ÂéüÂú∞‰ºëÊÅØ' }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Expanded Details -->
                    <div v-if="expandedStageIndex === index" class="mt-3 pt-3 border-t border-gray-100 text-sm text-gray-600">
                        
                        <!-- Êà∞Áï•ÂàÜÊûêÂçÄÂ°ä (ÊúÄÂÑ™ÂÖàÈ°ØÁ§∫) -->
                        <div v-if="stage.description" class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 mb-3 text-gray-700">
                            <div class="font-bold text-yellow-800 text-xs mb-1"><i class="fa-solid fa-lightbulb"></i> Êà∞Áï•ÂàÜÊûêÔºö</div>
                            {{ stage.description }}
                        </div>

                        <!-- ÂÖ∑È´îÁöÑËµ∑ÈªûËàáÁµÇÈªûÂ∫áË≠∑ÊâÄË≥áË®ä -->
                        <div v-if="stage.startAlbergue || stage.endAlbergue" class="mb-3 space-y-1">
                             <div v-if="stage.startAlbergue" class="flex gap-2 text-xs">
                                <span class="text-gray-500 shrink-0 w-8">Ëµ∑ÈªûÔºö</span>
                                <span class="text-gray-800 font-medium">{{ stage.startAlbergue }}</span>
                            </div>
                            <div v-if="stage.endAlbergue" class="flex gap-2 text-xs">
                                <span class="text-gray-500 shrink-0 w-8">ÁµÇÈªûÔºö</span>
                                <span class="text-gray-800 font-medium">{{ stage.endAlbergue }}</span>
                            </div>
                        </div>

                        <div v-if="stage.type !== 'rest' && stage.type !== 'bus'" class="flex justify-between mb-2">
                            <p><span class="font-semibold text-gray-800">Èõ£Â∫¶Ôºö</span> 
                                <span :class="{
                                    'text-red-500': stage.difficulty === 'Hard',
                                    'text-yellow-600': stage.difficulty === 'Medium',
                                    'text-green-600': stage.difficulty === 'Easy'
                                }">{{ stage.difficulty }}</span>
                            </p>
                            <button class="text-blue-600 font-medium text-xs flex items-center gap-1" @click="flyToStage(index)">
                                <i class="fa-solid fa-map"></i> Âú∞ÂúñÊü•Áúã
                            </button>
                        </div>

                        <!-- Accommodation & POI Section within Stage -->
                        <div v-if="stage.to && stage.type !== 'bus' && stage.type !== 'rest'" class="border-t border-gray-200 pt-3">
                            <h4 class="font-bold text-gray-700 text-sm mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-bed text-blue-500"></i> Êé®Ëñ¶‰ΩèÂÆø ({{ stage.to }})
                            </h4>
                            
                            <div v-if="getStagePois(stage.to).length > 0">
                                <div v-for="poi in getStagePois(stage.to)" :key="poi.id" class="bg-gray-50 rounded-lg p-3 mb-2 border border-gray-200 shadow-sm">
                                    <div class="flex justify-between items-start mb-1">
                                        <h5 class="font-bold text-gray-800 text-sm">{{ poi.name }}</h5>
                                        <span class="text-[10px] px-1.5 py-0.5 rounded font-medium"
                                            :class="{
                                                'bg-green-100 text-green-700': poi.category === 'ÂÖ¨Á´ã' || poi.category === 'Xunta',
                                                'bg-purple-100 text-purple-700': poi.category === 'ÁßÅÁ´ã',
                                                'bg-yellow-100 text-yellow-700': poi.category === 'ÊïôÊúÉ'
                                            }">{{ poi.category === 'Xunta' ? 'ÂÖ¨Á´ã (Xunta)' : poi.category }}</span>
                                    </div>
                                    
                                    <div class="flex items-center gap-3 text-xs text-gray-600 mb-1">
                                        <span class="flex items-center gap-1"><i class="fa-solid fa-euro-sign text-blue-400"></i> {{ poi.price }}</span>
                                        <span class="flex items-center gap-1"><i class="fa-solid fa-bed text-blue-400"></i> {{ poi.beds }} Â∫ä</span>
                                    </div>

                                    <div class="flex flex-wrap gap-1 my-1.5">
                                        <span v-for="fac in poi.facilities" :key="fac" class="text-[10px] bg-white border border-gray-100 px-1.5 py-0.5 rounded text-gray-500">
                                            {{ getFacilityName(fac) }}
                                        </span>
                                    </div>
                                    
                                    <button @click="showPoiOnMap(poi)" class="w-full mt-2 bg-white border border-blue-200 text-blue-600 text-xs py-1.5 rounded hover:bg-blue-50 transition">
                                        Êü•ÁúãË©≥Á¥∞ & ÂÆö‰Ωç
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: GUIDE -->
            <div v-if="currentView === 'guide'" class="p-0 h-full flex flex-col">
                <!-- Tabs -->
                <div class="flex border-b border-gray-200 bg-white">
                    <button @click="guideTab = 'packing'" :class="guideTab === 'packing' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500'" class="flex-1 py-3 text-sm font-medium border-b-2 transition">Ë£ùÂÇôÊ∏ÖÂñÆ</button>
                    <button @click="guideTab = 'emergency'" :class="guideTab === 'emergency' ? 'border-red-600 text-red-600' : 'border-transparent text-gray-500'" class="flex-1 py-3 text-sm font-medium border-b-2 transition">Á∑äÊÄ•Ë≥áË®ä</button>
                </div>

                <div class="p-4 overflow-y-auto pb-32">
                    <!-- Packing List -->
                    <div v-if="guideTab === 'packing'">
                        <!-- Weight Dashboard -->
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-sm font-bold text-gray-700">üéí ËÉåÂåÖÁ∏ΩÈáç</h3>
                                    <p class="text-xs text-gray-400">Âª∫Ë≠∞Âú® 10kg ‰ª•ÂÖß</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-2xl font-bold" :class="totalWeight > 10 ? 'text-red-500' : 'text-blue-600'">{{ totalWeight }}</span>
                                    <span class="text-sm text-gray-500 ml-1">kg</span>
                                </div>
                            </div>
                        </div>

                        <div v-for="(category, catName) in packingList" :key="catName" class="mb-6">
                            <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2 capitalize">
                                <i class="fa-solid fa-caret-right text-yellow-500"></i> {{ catName }}
                            </h3>
                            <div class="space-y-2">
                                <!-- List Items Wrapper -->
                                <template v-for="(item, idx) in category" :key="idx">
                                    
                                    <!-- Editing Mode (Inline Input) -->
                                    <div v-if="editingState.category === catName && editingState.index === idx" 
                                         class="flex items-center gap-2 bg-blue-50 p-2 rounded-lg border border-blue-200 shadow-inner h-[58px]">
                                        <input type="text" v-model="editForm.name" 
                                               class="flex-1 bg-white border border-blue-200 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-400"
                                               @keyup.enter="saveEdit(catName, idx)" ref="editInput">
                                        <input type="number" v-model="editForm.weight" 
                                               class="w-16 bg-white border border-blue-200 rounded px-1 py-1 text-sm focus:outline-none focus:border-blue-400 text-center"
                                               @keyup.enter="saveEdit(catName, idx)">
                                        <button @click="saveEdit(catName, idx)" class="text-green-600 hover:text-green-700 p-2">
                                            <i class="fa-solid fa-check"></i>
                                        </button>
                                    </div>

                                    <!-- Swipeable Item Container -->
                                    <div v-else class="relative overflow-hidden rounded-lg h-[58px] select-none">
                                        
                                        <!-- Background Actions (Reveal on swipe) -->
                                        <div class="absolute inset-y-0 right-0 flex w-[120px]">
                                            <button @click="startEditing(catName, idx)" class="w-1/2 bg-gray-200 text-gray-600 flex items-center justify-center hover:bg-gray-300 transition active:bg-gray-400">
                                                <i class="fa-solid fa-pen"></i>
                                            </button>
                                            <button @click="deleteItem(catName, idx)" class="w-1/2 bg-red-500 text-white flex items-center justify-center hover:bg-red-600 transition active:bg-red-700">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </button>
                                        </div>

                                        <!-- Foreground Content (Draggable) -->
                                        <div class="absolute inset-0 bg-white border border-gray-100 flex items-center px-3 gap-3 transition-transform duration-200 ease-out"
                                             :style="getSwipeStyle(catName, idx)"
                                             @touchstart="handleTouchStart($event, catName, idx)"
                                             @touchmove="handleTouchMove($event)"
                                             @touchend="handleTouchEnd($event)"
                                             @mousedown="handleTouchStart($event, catName, idx)" 
                                             @mousemove="handleTouchMove($event)"
                                             @mouseup="handleTouchEnd($event)"
                                             @mouseleave="handleTouchEnd($event)">
                                            
                                            <!-- Checkbox Area -->
                                            <div @click="!isSwiping && toggleItem(catName, idx)" class="cursor-pointer shrink-0 p-1">
                                                <div class="w-5 h-5 rounded-full border flex items-center justify-center transition-colors"
                                                     :class="item.checked ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300 text-transparent'">
                                                    <i class="fa-solid fa-check text-xs"></i>
                                                </div>
                                            </div>

                                            <!-- Content Area -->
                                            <div class="flex-1 flex justify-between items-center cursor-pointer" @click="!isSwiping && toggleItem(catName, idx)">
                                                <span :class="{'text-gray-400 line-through': item.checked}">{{ item.name }}</span>
                                                <span v-if="item.weight" class="text-xs text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded ml-2 whitespace-nowrap">{{ item.weight }}g</span>
                                            </div>
                                            
                                            <!-- Visual hint for swipe (optional) -->
                                            <div class="w-1 h-8 bg-gray-100 rounded-full mx-1 opacity-50"></div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Add Item Row -->
                                <div class="flex items-center gap-2 mt-2 px-1 pt-1 h-[40px]">
                                    <div class="w-5 h-5 flex items-center justify-center text-gray-300">
                                        <i class="fa-solid fa-plus text-xs"></i>
                                    </div>
                                    <input type="text" v-model="newItemInput[catName].name" 
                                           placeholder="Êñ∞Â¢ûË£ùÂÇô..." 
                                           class="flex-1 bg-transparent border-b border-gray-200 px-2 py-1.5 text-sm focus:outline-none focus:border-blue-400 placeholder-gray-400 transition-colors"
                                           @keyup.enter="addItem(catName)">
                                    <input type="number" v-model="newItemInput[catName].weight" 
                                           placeholder="ÂÖã" 
                                           class="w-14 bg-transparent border-b border-gray-200 px-1 py-1.5 text-sm focus:outline-none focus:border-blue-400 text-center placeholder-gray-300 transition-colors"
                                           @keyup.enter="addItem(catName)">
                                    <button @click="addItem(catName)" 
                                            class="text-blue-500 hover:text-blue-700 w-8 h-8 flex items-center justify-center transition disabled:opacity-30 disabled:cursor-not-allowed" 
                                            :disabled="!newItemInput[catName].name">
                                        <i class="fa-solid fa-check"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Emergency -->
                    <div v-if="guideTab === 'emergency'" class="space-y-4">
                        <div class="bg-red-50 border border-red-200 p-4 rounded-xl">
                            <h3 class="font-bold text-red-700 text-lg mb-2"><i class="fa-solid fa-triangle-exclamation"></i> Ê≠êÁõüÁ∑äÊÄ•ÈõªË©±</h3>
                            <div class="text-4xl font-black text-red-600 mb-1">112</div>
                            <p class="text-sm text-red-800">ÈÅ©Áî®ÊñºË•øÁè≠ÁâôÂÖ®Â¢ÉÔºåÂèØÈÄöËã±Ë™û„ÄÇ</p>
                        </div>
                        
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="font-bold mb-2">‰∏ªË¶ÅÈÜ´ÁôÇ‰∏≠ÂøÉ</h3>
                            <div class="space-y-3">
                                <div class="border-b pb-2">
                                    <div class="font-medium">Hospital de Navarra (Pamplona)</div>
                                    <div class="text-sm text-gray-500">+34 848 42 22 22</div>
                                </div>
                                <div>
                                    <div class="font-medium">Hospital Cl√≠nico (Santiago)</div>
                                    <div class="text-sm text-gray-500">+34 981 95 00 00</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="font-bold mb-2">ÂØ¶Áî®Áü≠Ë™û (Ë•øÊñá)</h3>
                            <ul class="text-sm space-y-2">
                                <li><span class="font-semibold">ÊàëÈúÄË¶ÅÂπ´Âä©:</span> Necesito ayuda</li>
                                <li><span class="font-semibold">ÊàëÂèóÂÇ∑‰∫Ü:</span> Estoy herido</li>
                                <li><span class="font-semibold">Ê∞¥Ê≥°:</span> Ampollas</li>
                                <li><span class="font-semibold">Ëó•Â±Ä:</span> Farmacia</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="bg-white border-t border-gray-200 grid grid-cols-5 h-16 shrink-0 z-30 pb-safe relative px-6">
            <button @click="setView('dashboard')" :class="currentView === 'dashboard' ? 'text-blue-600' : 'text-gray-400'" class="flex flex-col items-center justify-center h-full">
                <i class="fa-solid fa-house text-xl mb-1"></i>
                <span class="text-[10px] font-medium">È¶ñÈ†Å</span>
            </button>
            <button @click="setView('map')" :class="currentView === 'map' ? 'text-blue-600' : 'text-gray-400'" class="flex flex-col items-center justify-center h-full">
                <i class="fa-solid fa-map-location-dot text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Âú∞Âúñ</span>
            </button>
            
            <!-- ‰∏≠ÈñìÊåâÈàïÂçÄÂ°ä -->
            <div class="flex justify-center items-center relative">
                <button class="absolute -top-8 bg-yellow-400 text-white w-20 h-20 rounded-full shadow-xl flex items-center justify-center border-4 border-white transform active:scale-95 transition z-40 overflow-visible" @click="quickLog">
                    <i class="fa-solid fa-person-hiking text-3xl"></i>
                </button>
            </div>
            
            <button @click="setView('stages')" :class="currentView === 'stages' ? 'text-blue-600' : 'text-gray-400'" class="flex flex-col items-center justify-center h-full">
                <i class="fa-solid fa-list-check text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Ë∑ØÊÆµ</span>
            </button>
            <button @click="setView('guide')" :class="currentView === 'guide' ? 'text-blue-600' : 'text-gray-400'" class="flex flex-col items-center justify-center h-full">
                <i class="fa-solid fa-book-open text-xl mb-1"></i>
                <span class="text-[10px] font-medium">ÊåáÂçó</span>
            </button>
        </nav>

        <!-- Toast Notification -->
        <transition name="fade">
            <div v-if="toastMsg" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm">
                {{ toastMsg }}
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        createApp({
            setup() {
                const currentView = ref('dashboard');
                const guideTab = ref('packing');
                const toastMsg = ref('');
                const expandedStageIndex = ref(null);
                const isWeatherExpanded = ref(true);
                
                // Á∑®ËºØÁõ∏ÈóúÁãÄÊÖã
                const editingState = ref({ category: null, index: null });
                const editForm = ref({ name: '', weight: 0 });
                const editInput = ref(null);

                // Swipe Logic State
                const swipeState = ref({
                    activeId: null, // format: "category-index"
                    startX: 0,
                    startY: 0,
                    currentOffset: 0,
                    baseOffset: 0,
                    isDragging: false
                });
                const isSwiping = ref(false); 
                const interactingId = ref(null); 

                // Âú∞ÂúñÁõ∏Èóú
                let map = null;
                let userMarker = null;
                const selectedPOI = ref(null);
                const filters = ref({ albergue: true, sight: true, food: true, water: false });
                
                // Ëµ∑ÈªûÂ∫ßÊ®ô: Saint-Jean-Pied-de-Port
                const startPoint = { lat: 43.1636, lng: -1.2358 };

                // Ê®°Êì¨ÊØèÂ∞èÊôÇÂ§©Ê∞£È†êÂ†±Êï∏Êìö
                const hourlyForecast = ref([
                    { time: '07:00', temp: 14, icon: 'fa-cloud-sun' },
                    { time: '08:00', temp: 15, icon: 'fa-sun' },
                    { time: '09:00', temp: 17, icon: 'fa-sun' },
                    { time: '10:00', temp: 19, icon: 'fa-sun' },
                    { time: '11:00', temp: 21, icon: 'fa-cloud-sun' },
                    { time: '12:00', temp: 22, icon: 'fa-cloud' },
                    { time: '13:00', temp: 23, icon: 'fa-cloud-rain' },
                    { time: '14:00', temp: 22, icon: 'fa-cloud-rain' },
                    { time: '15:00', temp: 21, icon: 'fa-cloud' },
                    { time: '16:00', temp: 20, icon: 'fa-cloud-sun' },
                ]);

                // Ê†πÊìöÁï∂ÂâçÊ∞£Ê∫´ÔºàÊ®°Êì¨ÔºâÊèê‰æõÁ©øË°£Âª∫Ë≠∞
                const clothingAdvice = computed(() => {
                    const temp = 22; // Ê®°Êì¨Áï∂ÂâçÊ∞£Ê∫´
                    if (temp < 10) return "ÂØíÂÜ∑ÔºöÂª∫Ë≠∞Á©øËëó‰øùÊöñÂÖßÂ±§„ÄÅ‰∏≠Â±§Ë°£Áâ©ÂèäÈò≤È¢®Â§ñÂ•ó„ÄÇ";
                    if (temp < 18) return "Ê∂ºÁàΩÔºöÂª∫Ë≠∞Ê¥ãËî•ÂºèÁ©øÊ≥ïÔºåËñÑÈï∑Ë¢ñÊê≠ÈÖçËºïÈáèÂ§ñÂ•ó„ÄÇ";
                    if (temp < 25) return "ËàíÈÅ©ÔºöÈÅ©ÂêàÁü≠Ë¢ñÊàñËñÑÈï∑Ë¢ñÔºåÊó©ÊôöÊ∫´Â∑ÆÂ§ßË´ãÂÇôËñÑÂ§ñÂ•ó„ÄÇ";
                    return "ÁÇéÁÜ±ÔºöË´ãËëóÈÄèÊ∞£Âø´‰πæÁü≠Ë¢ñÔºåÊ≥®ÊÑèÈò≤Êõ¨ËàáË£úÂÖÖÊ∞¥ÂàÜ„ÄÇ";
                });

                // 20 Â§©Ë©≥Á¥∞Ë¶èÂäÉË∑ØÊÆµË≥áÊñô (Part 1 + Part 2 Bus/Rest + Part 3 Final)
                const stages = ref([
                    // Part 1: Classic Beginning (Day 1-11)
                    { from: 'Saint-Jean-Pied-de-Port', to: 'Roncesvalles', km: 24.7, difficulty: 'Hard', terrain: 'Mountain', lat: 43.0094, lng: -1.3194, completed: false, 
                      startAlbergue: "(ÊÇ®Âú®SJPPÁöÑ‰ΩèËôï)", 
                      endAlbergue: "Albergue de Peregrinos de Roncesvalles",
                      description: "Á≤æËèØ‰øùÁïô„ÄÇÈ´îÈ©óÊúÄÁ∂ìÂÖ∏ÁöÑÂ∫áÈáåÁâõÊñØÂ±±ÊåëÊà∞„ÄÇÈÄôÊòØÊúùËÅñ‰πãË∑ØÊúÄËâ±Èõ£‰ΩÜ‰πüÊúÄÂ£ØÈ∫óÁöÑ‰∏ÄÂ§©„ÄÇ" },
                    
                    { from: 'Roncesvalles', to: 'Zubiri', km: 21.4, difficulty: 'Medium', terrain: 'Forest Path', lat: 42.9309, lng: -1.5034, completed: false, 
                      startAlbergue: "Albergue de Peregrinos de Roncesvalles", 
                      endAlbergue: "Albergue Municipal de Zubiri",
                      description: "ËÆìÈõôËÖøÂú®Á¨¨‰∏ÄÂ§©ÁøªÂ±±Ë∂äÂ∂∫ÂæåÂæóÂà∞ÊÅ¢Âæ©ÔºåÁ©øÊ¢≠Âú®ÂπΩÈùúÁöÑÊ£ÆÊûóÂ∞èÂæë‰∏≠„ÄÇ" },
                    
                    { from: 'Zubiri', to: 'Pamplona', km: 20.8, difficulty: 'Easy', terrain: 'Road/Path', lat: 42.8125, lng: -1.6458, completed: false, 
                      startAlbergue: "Albergue Municipal de Zubiri", 
                      endAlbergue: "Albergue de Peregrinos Jes√∫s y Mar√≠a",
                      description: "ËºïÈ¨ÜËµ∞ÈÄ≤Á¨¨‰∏ÄÂÄãÂ§ßÂüé PamplonaÔºåË®òÂæóÂéªÂèÉËßÄÂ§ßÊïôÂ†Ç‰∏¶‰∫´Áî® TapasÔºÅ" },
                    
                    { from: 'Pamplona', to: 'Puente la Reina', km: 24.3, difficulty: 'Medium', terrain: 'Alto del Perd√≥n', lat: 42.6719, lng: -1.8153, completed: false, 
                      startAlbergue: "Albergue de Peregrinos Jes√∫s y Mar√≠a", 
                      endAlbergue: "Albergue de Peregrinos de los Padres Reparadores",
                      description: "Á≤æËèØ‰øùÁïô„ÄÇÊîÄÁôªËëóÂêçÁöÑ„ÄåÂØ¨ÊÅï‰πãÂ∂∫„Äç(Alto del Perd√≥n)ÔºåËàáÊúùËÅñËÄÖÈêµÈõïÂêàÂΩ±„ÄÇ" },
                    
                    { from: 'Puente la Reina', to: 'Estella', km: 21.9, difficulty: 'Medium', terrain: 'Rolling Hills', lat: 42.6713, lng: -2.0313, completed: false, 
                      startAlbergue: "Albergue de Peregrinos de los Padres Reparadores", 
                      endAlbergue: "Albergue Municipal de Peregrinos de Estella",
                      description: "‰∫´Âèó‰∏≠‰∏ñÁ¥ÄÊùëËéäÈ¢®ÂÖâÔºåEstella Ë¢´Á®±ÁÇ∫„ÄåÂåóÊñπÁöÑÊâòÈõ∑Â§ö„ÄçÔºåÊ≠∑Âè≤Ê∞õÂúçÊøÉÂéö„ÄÇ" },
                    
                    { from: 'Estella', to: 'Los Arcos', km: 21.6, difficulty: 'Medium', terrain: 'Rolling', lat: 42.5694, lng: -2.1906, completed: false, 
                      startAlbergue: "Albergue Municipal de Peregrinos de Estella", 
                      endAlbergue: "Albergue de Peregrinos Isaac Santiago",
                      description: "ÊãúË®™Áü•ÂêçÁöÑ Irache Á¥ÖÈÖíÂô¥Ê≥â (Fuente del Vino)ÔºåÂÖçË≤ªÂìÅÂöêÊúùËÅñËÄÖÁ¥ÖÈÖíÔºÅ" },
                    
                    { from: 'Los Arcos', to: 'Logro√±o', km: 27.9, difficulty: 'Hard', terrain: 'Rolling', lat: 42.4664, lng: -2.4456, completed: false, 
                      startAlbergue: "Albergue de Peregrinos Isaac Santiago", 
                      endAlbergue: "Albergue Municipal de Peregrinos de Logro√±o",
                      description: "ËàíÈÅ©Âú∞Ëµ∞ÈÄ≤ La Rioja Ëë°ËêÑÈÖíÁî¢ÂçÄÁöÑÈ¶ñÈÉΩ Logro√±oÔºåÊôö‰∏äÂøÖÂéª Laurel Ë°óÂêÉ Pintxos„ÄÇ" },
                    
                    { from: 'Logro√±o', to: 'N√°jera', km: 29.3, difficulty: 'Hard', terrain: 'Vineyards', lat: 42.4156, lng: -2.7344, completed: false, 
                      startAlbergue: "Albergue Municipal de Peregrinos de Logro√±o", 
                      endAlbergue: "Albergue Municipal de N√°jera",
                      description: "ÈÄôÊòØÂ∞ëÊï∏Êé•Ëøë 30km ÁöÑ‰∏ÄÂ§©Ôºå‰ΩÜÂú∞Âã¢Âπ≥Âù¶ÔºåÊ≤øÈÄîÁ∂ìÈÅéÁæéÈ∫óÁöÑËë°ËêÑÂúí„ÄÇ" },
                    
                    { from: 'N√°jera', to: 'Santo Domingo de la Calzada', km: 21.1, difficulty: 'Easy', terrain: 'Rolling', lat: 42.4394, lng: -2.9536, completed: false, 
                      startAlbergue: "Albergue Municipal de N√°jera", 
                      endAlbergue: "Albergue de Peregrinos de la Cofrad√≠a del Santo",
                      description: "ËºïÈ¨ÜÁöÑ‰∏ÄÂ§©ÔºåÁµÇÈªûÊòØËëóÂêçÁöÑ„ÄåÈõûËàçÂ•áËπü„ÄçÊïôÂ†ÇÊâÄÂú®Âú∞„ÄÇ" },
                    
                    { from: 'Santo Domingo de la Calzada', to: 'Belorado', km: 22.7, difficulty: 'Easy', terrain: 'Flat', lat: 42.4194, lng: -3.1911, completed: false, 
                      startAlbergue: "Albergue de Peregrinos de la Cofrad√≠a del Santo", 
                      endAlbergue: "Albergue de Peregrinos A Santiago",
                      description: "ËàíÈÅ©Âú∞Êé®ÈÄ≤ÔºåBelorado ÊìÅÊúâ‰∏çÂ∞ëËàíÈÅ©ÁöÑÁßÅÁ´ãÂ∫áË≠∑ÊâÄ„ÄÇ" },
                    
                    { from: 'Belorado', to: 'Burgos', km: 27.5, difficulty: 'Medium', terrain: 'Flat/Urban', lat: 42.3408, lng: -3.7028, completed: false, 
                      startAlbergue: "Albergue de Peregrinos A Santiago", 
                      endAlbergue: "Albergue Municipal de Peregrinos de Burgos",
                      description: "Á©øË∂äÂ±±‰∏òËàáÂ∑•Ê•≠ÂçÄÔºåÊäµÈÅîÊìÅÊúâÂ£ØËßÄÂ§ßÊïôÂ†ÇÁöÑ BurgosÔºåÈÄôË£°ÊòØÁ¨¨‰∏ÄÈöéÊÆµÁöÑÁµÇÈªû„ÄÇ" },

                    // Part 2: Strategic Jump (Day 12-13)
                    { from: 'Burgos', to: 'Sarria', km: 0, difficulty: 'None', type: 'bus', terrain: 'Bus Transfer', lat: 42.7778, lng: -7.4125, completed: false, 
                      virtualKm: 399.7, // ÈóúÈçµÔºöÈÄôÊòØË¢´Ë∑≥ÈÅéÁöÑË∑ùÈõ¢
                      startAlbergue: "Albergue Municipal de Burgos (Ê≠•Ë°åËá≥Â∑¥Â£´Á´ô)",
                      endAlbergue: "Albergue Internacional Monasterio de la Magdalena",
                      description: "üöå Â∑¥Â£´Ë∑≥Ë∫çÊó•ÔºöÈÄôÂ∞±ÊòØÁØÄÁúÅÊôÇÈñìÁöÑÁßòÂØÜÔºÅÂæû Burgos ÊÇ†ÈñíÊé¢Á¥¢ÂæåÔºåÊê≠‰πò ALSA Â∑¥Â£´Ë∑≥ÈÅé 300 ÂÖ¨ÈáåÔºåÁõ¥Êé•ÊäµÈÅî„ÄåÊúÄÂæå100ÂÖ¨Èáå„ÄçÁöÑËµ∑Èªû Sarria„ÄÇÁúÅ‰∏ã 10-12 Â§©Ê≠•Ë°åÊôÇÈñì„ÄÇ" },
                    
                    { from: 'Sarria', to: 'Sarria', km: 0, difficulty: 'None', type: 'rest', terrain: 'Rest Day', lat: 42.7778, lng: -7.4125, completed: false, 
                      startAlbergue: "Albergue Internacional Monasterio de la Magdalena",
                      endAlbergue: "Albergue Internacional Monasterio de la Magdalena",
                      description: "üí§ ÊÅ¢Âæ©Êó•ÔºöÂú® Sarria ÂæπÂ∫ï‰ºëÊÅØ„ÄÇÊ¥óÊªåË°£Áâ©„ÄÅÊé°Ë≥ºË£úÁµ¶ÔºåËÆìË∫´È´îÂæûÈï∑ÈÄîËªäÁ®ã‰∏≠ÊÅ¢Âæ©ÔºåÁ≤æÁ•ûÈ£ΩÊªøÂú∞Ê∫ñÂÇôÊúÄÂæåË°ùÂà∫„ÄÇ" },

                    // Part 3: Final Chapter (Day 14-20)
                    { from: 'Sarria', to: 'Portomar√≠n', km: 22.5, difficulty: 'Easy', terrain: 'Rolling (Galicia)', lat: 42.8067, lng: -7.6156, completed: false, 
                      startAlbergue: "Albergue Internacional Monasterio de la Magdalena", 
                      endAlbergue: "Albergue de Peregrinos de la Xunta de Portomar√≠n",
                      description: "Á≤æËèØ‰øùÁïô„ÄÇÈñãÂßã‰∫´Âèó„ÄåÊúÄÂæå100ÂÖ¨Èáå„ÄçÁöÑÁÜ±È¨ßËàáÈ¢®ÊôØÔºåÊ≤øÈÄîÊúÉÊúâË®±Â§öÊèê‰æõÂç∞Á´†ÁöÑÂ∞èÂ∫ó„ÄÇ" },
                    
                    { from: 'Portomar√≠n', to: 'Palas de Rei', km: 25.1, difficulty: 'Medium', terrain: 'Hills', lat: 42.8739, lng: -7.8692, completed: false, 
                      startAlbergue: "Albergue de Peregrinos de la Xunta de Portomar√≠n", 
                      endAlbergue: "Albergue de Peregrinos de la Xunta de Palas de Rei",
                      description: "ÂÖ∏ÂûãÁöÑÂä†Âà©Ë•ø‰∫û‰∏òÈôµÂú∞ÂΩ¢ÔºåËàá‰æÜËá™‰∏ñÁïåÂêÑÂú∞ÁöÑÊúùËÅñËÄÖÂêåË°åÔºåÊÑüÂèóÁÜ±È¨ßÊ∞õÂúç„ÄÇ" },
                    
                    { from: 'Palas de Rei', to: 'Arz√∫a', km: 29.0, difficulty: 'Hard', terrain: 'Rolling/Forest', lat: 42.9269, lng: -8.1644, completed: false, 
                      startAlbergue: "Albergue de Peregrinos de la Xunta de Palas de Rei", 
                      endAlbergue: "Albergue de Peregrinos de la Xunta de Arz√∫a",
                      description: "ÈÄîÁ∂ì MelideÔºå‰∏ÄÂÆöË¶ÅÂÅú‰∏ã‰æÜÂêÉÈ†ìËëóÂêçÁöÑÂä†Âà©Ë•ø‰∫ûÁ´†È≠öÂ§ßÈ§ê (Pulpo)ÔºÅ" },
                    
                    { from: 'Arz√∫a', to: 'O Pedrouzo', km: 19.5, difficulty: 'Easy', terrain: 'Forest/Eucalyptus', lat: 42.9108, lng: -8.3617, completed: false, 
                      startAlbergue: "Albergue de Peregrinos de la Xunta de Arz√∫a", 
                      endAlbergue: "Albergue de Peregrinos de la Xunta de Arca do Pino",
                      description: "Ë∑ùÈõ¢ÁµÇÈªûÊúÄËøëÁöÑ‰∏ÄÁ´ôÔºåÁ©øÊ¢≠Âú®ÂÖÖÊªøÈ¶ôÊ∞£ÁöÑÂ∞§Âä†Âà©Ê®πÊûó‰∏≠ÔºåÂøÉÊÉÖÈñãÂßãÊøÄÂãï„ÄÇ" },
                    
                    { from: 'O Pedrouzo', to: 'Santiago de Compostela', km: 20.0, difficulty: 'Easy', terrain: 'Arrival', lat: 42.8805, lng: -8.5439, completed: false, 
                      startAlbergue: "Albergue de Peregrinos de la Xunta de Arca do Pino", 
                      endAlbergue: "Seminario Menor de la Asunci√≥n",
                      description: "Ê¶ÆËÄÄÊó•ÔºÅÊÇ†ÈñíÂú∞Ëµ∞ÂÆåÊúÄÂæå‰∏ÄÁ®ãÔºåÁõÆÊ®ôÂú®‰∏≠ÂçàÂâçÊäµÈÅîÂ§ßÊïôÂ†ÇÂª£Â†¥ÔºåÂèÉÂä†ÊúùËÅñËÄÖÂΩåÊíí„ÄÇ" },
                    
                    { from: 'Santiago', to: 'Santiago', km: 0, difficulty: 'None', type: 'rest', terrain: 'Celebration', lat: 42.8805, lng: -8.5439, completed: false, 
                      startAlbergue: "Santiago de Compostela",
                      endAlbergue: "Santiago de Compostela",
                      description: "üéâ ÊÖ∂Á•ùËàáÊé¢Á¥¢Êó•ÔºöÈ†òÂèñÂ†ÜËÇ•Ë≠âÊõ∏„ÄÅÂèÉËßÄÂ§ßÊïôÂ†Ç„ÄÅÈÄõÈÄõÂè§ÂüéÔºå‰∫´ÂèóÂ±¨ÊñºÊÇ®ÁöÑÊ¶ÆËÄÄÊôÇÂàª„ÄÇÈÄôÊòØÊÇ®ÊáâÂæóÁöÑÁçéÂãµÔºÅ" },
                    
                    { from: 'Santiago', to: 'Santiago', km: 0, difficulty: 'None', type: 'rest', terrain: 'Buffer Day', lat: 42.8805, lng: -8.5439, completed: false, 
                      startAlbergue: "Santiago de Compostela",
                      endAlbergue: "Santiago de Compostela",
                      description: "ÂÇôÁî®Á∑©Ë°ùÊó•ÔºöÊ•µÈ´òÁöÑÂÆπÈåØÁéáÔºåÂèØÊáâÂ∞ç‰ªª‰ΩïÁ™ÅÁôºÁãÄÊ≥Å„ÄÇ" }
                ]);

                // Ê®°Êì¨Êï∏ÊìöÔºöPOI
                const pois = [
                    // Part 1 Specific Albergues
                    { id: 1, lat: 43.0094, lng: -1.3194, name: "Albergue de Peregrinos de Roncesvalles", type: "albergue", category: "ÊïôÊúÉ", location: "Roncesvalles", price: "‚Ç¨14", beds: 183, phone: "+34 948 760 000", facilities: ["kitchen", "laundry", "wifi", "dinner"], landmarks: "ËÅñÁë™Ëéâ‰∫ûËÅØÂêàÊïôÂ†Ç", description: "Ê≠∑Âè≤ÊÇ†‰πÖ‰∏îË¶èÊ®°ÂÆèÂ§ßÁöÑÊúùËÅñËÄÖÂ∫áË≠∑ÊâÄ„ÄÇ" },
                    { id: 102, lat: 42.9309, lng: -1.5034, name: "Albergue Municipal de Zubiri", type: "albergue", category: "ÂÖ¨Á´ã", location: "Zubiri", price: "‚Ç¨10", beds: 46, phone: "ÁÑ°", facilities: ["hot_water", "kitchen"], landmarks: "ÁãÇÁä¨ÁóÖ‰πãÊ©ã", description: "ËàäÂ∞èÂ≠∏ÊîπÂª∫ÔºåÂü∫Êú¨Ë®≠ÊñΩ„ÄÇ" },
                    { id: 103, lat: 42.8185, lng: -1.6443, name: "Albergue de Peregrinos Jes√∫s y Mar√≠a", type: "albergue", category: "ÂÖ¨Á´ã", location: "Pamplona", price: "‚Ç¨11", beds: 112, phone: "+34 948 22 26 44", facilities: ["kitchen", "laundry", "wifi"], landmarks: "ÊΩòÊôÆÊ¥õÁ¥ç‰∏ªÊïôÂ†Ç", description: "‰ΩçÊñºÂ∏Ç‰∏≠ÂøÉÔºåÁèæ‰ª£ÂåñÊîπÂª∫ÁöÑÂè§ËÄÅÊïôÂ†Ç„ÄÇ" },
                    { id: 104, lat: 42.6719, lng: -1.8153, name: "Albergue de Peregrinos de los Padres Reparadores", type: "albergue", category: "ÊïôÊúÉ", location: "Puente la Reina", price: "‚Ç¨13", beds: 100, phone: "+34 948 34 00 50", facilities: ["garden", "kitchen", "laundry"], landmarks: "ÁöáÂêéÊ©ã", description: "Áî±‰øÆÊúÉÁÆ°ÁêÜÔºåÂ∫≠Èô¢ÂØßÈùú„ÄÇ" },
                    { id: 105, lat: 42.6713, lng: -2.0313, name: "Albergue Municipal de Peregrinos de Estella", type: "albergue", category: "ÂÖ¨Á´ã", location: "Estella", price: "‚Ç¨6", beds: 96, phone: "+34 948 55 05 48", facilities: ["kitchen", "laundry"], landmarks: "ËÅñÂΩºÂæóÊïôÂ†Ç", description: "ÂÉπÊ†ºÂØ¶ÊÉ†ÔºåÁ©∫ÈñìÂØ¨Êïû„ÄÇ" },
                    { id: 106, lat: 42.5694, lng: -2.1906, name: "Albergue de Peregrinos Isaac Santiago", type: "albergue", category: "ÂÖ¨Á´ã", location: "Los Arcos", price: "‚Ç¨8", beds: 70, phone: "+34 948 64 00 02", facilities: ["kitchen", "garden"], landmarks: "ËÅñÁë™Ëéâ‰∫ûÊïôÂ†Ç", description: "ÊØîÂà©ÊôÇ‰πãÂèãÂçîÊúÉÁÆ°ÁêÜ„ÄÇ" },
                    { id: 107, lat: 42.4664, lng: -2.4456, name: "Albergue Municipal de Peregrinos de Logro√±o", type: "albergue", category: "ÂÖ¨Á´ã", location: "Logro√±o", price: "‚Ç¨10", beds: 64, phone: "+34 941 24 88 18", facilities: ["kitchen", "laundry", "wifi"], landmarks: "ËÅñÂú∞ÁâôÂì•ÊïôÂ†Ç", description: "‰ΩçÊñºÂ∏Ç‰∏≠ÂøÉÔºåÂ§èÂ≠£ÊòìÂÆ¢Êªø„ÄÇ" },
                    { id: 108, lat: 42.4156, lng: -2.7344, name: "Albergue Municipal de N√°jera", type: "albergue", category: "ÂÖ¨Á´ã", location: "N√°jera", price: "‚Ç¨8", beds: 90, phone: "+34 941 36 00 41", facilities: ["kitchen", "laundry"], landmarks: "‰øÆÈÅìÈô¢", description: "Ê≤≥ÁïîÈ¢®ÊôØÂÑ™Áæé„ÄÇ" },
                    { id: 109, lat: 42.4394, lng: -2.9536, name: "Albergue de Peregrinos de la Cofrad√≠a del Santo", type: "albergue", category: "ÊïôÊúÉ", location: "Santo Domingo de la Calzada", price: "‚Ç¨10", beds: 215, phone: "+34 941 34 00 33", facilities: ["kitchen", "laundry"], landmarks: "ËÅñÂ§öÊòéÂì•Â§ßÊïôÂ†Ç", description: "Ê≠∑Âè≤ÊÇ†‰πÖÔºåÂ∫ä‰ΩçÁúæÂ§ö„ÄÇ" },
                    { id: 110, lat: 42.4194, lng: -3.1911, name: "Albergue de Peregrinos A Santiago", type: "albergue", category: "ÁßÅÁ´ã", location: "Belorado", price: "‚Ç¨12", beds: 40, phone: "+34 947 58 06 17", facilities: ["pool", "bar", "wifi"], landmarks: "ËÅñÁë™Ëéâ‰∫ûÊïôÂ†Ç", description: "ËàíÈÅ©ÁöÑÁßÅÁ´ãÂ∫áË≠∑ÊâÄÔºåÊúâÊ≥≥Ê±†„ÄÇ" },
                    { id: 112, lat: 42.3408, lng: -3.7028, name: "Albergue Municipal de Peregrinos de Burgos", type: "albergue", category: "ÂÖ¨Á´ã", location: "Burgos", price: "‚Ç¨5", beds: 150, phone: "+34 947 26 31 49", facilities: ["kitchen", "laundry", "wifi"], landmarks: "Â∏ÉÁàæÊààÊñØ‰∏ªÊïôÂ†Ç", description: "Âç≥ Casa de los CubosÔºå‰ΩçÁΩÆÁµï‰Ω≥„ÄÇ" },

                    // Part 2 & 3 Specific Albergues
                    { id: 301, lat: 42.7778, lng: -7.4125, name: "Albergue Internacional Monasterio de la Magdalena", type: "albergue", category: "ÁßÅÁ´ã", location: "Sarria", price: "‚Ç¨12", beds: 110, phone: "+34 982 53 05 52", facilities: ["laundry", "kitchen", "wifi"], landmarks: "È¶¨Ê†ºÈÅîËêäÁ¥ç‰øÆÈÅìÈô¢", description: "‰ΩçÊñº‰øÆÈÅìÈô¢ÂÖßÁöÑÂ∫áË≠∑ÊâÄÔºåÁí∞Â¢ÉÊ∏ÖÂπΩÔºåÈÅ©Âêà‰ºëÊÅØÊÅ¢Âæ©„ÄÇ" },
                    
                    { id: 125, lat: 42.8067, lng: -7.6156, name: "Albergue de Peregrinos de la Xunta de Portomar√≠n", type: "albergue", category: "Xunta", location: "Portomar√≠n", price: "‚Ç¨10", beds: 114, phone: "ÁÑ°", facilities: ["kitchen", "laundry"], landmarks: "Â†°Â£òÊïôÂ†Ç", description: "Âä†Âà©Ë•ø‰∫ûÂÖ¨Á´ãÂ∫áË≠∑ÊâÄ (Xunta)Ôºå‰∏çËÉΩÈ†êË®ÇÔºåÈúÄÊéíÈöä„ÄÇ" },
                    
                    { id: 126, lat: 42.8739, lng: -7.8692, name: "Albergue de Peregrinos de la Xunta de Palas de Rei", type: "albergue", category: "Xunta", location: "Palas de Rei", price: "‚Ç¨10", beds: 60, phone: "ÁÑ°", facilities: ["kitchen"], landmarks: "ËÅñÊèêÁàæÁ¥¢ÊïôÂ†Ç", description: "Âä†Âà©Ë•ø‰∫ûÂÖ¨Á´ãÂ∫áË≠∑ÊâÄ„ÄÇ" },
                    
                    { id: 127, lat: 42.9269, lng: -8.1644, name: "Albergue de Peregrinos de la Xunta de Arz√∫a", type: "albergue", category: "Xunta", location: "Arz√∫a", price: "‚Ç¨10", beds: 46, phone: "ÁÑ°", facilities: ["kitchen"], landmarks: "ËÅñÁë™Ëéâ‰∫ûÊïôÂ†Ç", description: "ÂÖ¨Á´ãÂ∫áË≠∑ÊâÄÔºåÂ∫ä‰ΩçËºÉÂ∞ëÔºåÂª∫Ë≠∞ÊèêÊó©ÊäµÈÅîÊàñÈÅ∏ÊìáÁßÅÁ´ã„ÄÇ" },
                    
                    { id: 128, lat: 42.9108, lng: -8.3617, name: "Albergue de Peregrinos de la Xunta de Arca do Pino", type: "albergue", category: "Xunta", location: "O Pedrouzo", price: "‚Ç¨10", beds: 126, phone: "ÁÑ°", facilities: ["kitchen", "wifi"], landmarks: "ËÅñËâæÊãâËéâ‰∫ûÊïôÂ†Ç", description: "‰ΩçÊñº O Pedrouzo ÁöÑÂÖ¨Á´ãÂ∫áË≠∑ÊâÄÔºåË∑ùÈõ¢ËÅñÂú∞ÁâôÂì•ÊúÄÂæå‰∏ÄÁ´ô„ÄÇ" },
                    
                    { id: 129, lat: 42.8805, lng: -8.5439, name: "Seminario Menor de la Asunci√≥n", type: "albergue", category: "ÁßÅÁ´ã", location: "Santiago de Compostela", price: "‚Ç¨17", beds: 177, phone: "+34 981 58 92 00", facilities: ["kitchen", "laundry", "single_rooms", "wifi"], landmarks: "ËÅñÂú∞ÁâôÂì•‰∏ªÊïôÂ∫ßÂ†Ç", description: "Áî±Á•ûÂ≠∏Èô¢ÊîπÂª∫ÔºåÁ©∫ÈñìÂ∑®Â§ßÔºåÊúâÂñÆ‰∫∫ÊàøÈÅ∏È†ÖÔºåÂ∞±Âú®Ë≤ùÁàæÁ∂≠ÊñØÂÖ¨ÂúíÊóÅ„ÄÇ" },

                     // --- Áü•ÂêçÊôØÈªû (Sights) ---
                    { id: 201, lat: 43.1630, lng: -1.2350, name: "ËÅñÈõÖÂêÑ‰πãÈñÄ (Porte St-Jacques)", type: "sight", description: "Ê≥ïÂúã‰πãË∑ØÁöÑÂÇ≥Áµ±Ëµ∑ÈªûÔºåËÅØÂêàÂúãÊïôÁßëÊñáÁµÑÁπî‰∏ñÁïåÈÅ∫Áî¢„ÄÇ" },
                    { id: 202, lat: 43.0094, lng: -1.3194, name: "ÊúóÂ°ûÊñØÁì¶ÂàóÊñØËÅØÂêàÊïôÂ†Ç", type: "sight", description: "ÂüãËë¨ËëóÁæÖËò≠ÁöÑÂÇ≥Ë™™‰πãÂú∞ÔºåÂì•Âæ∑ÂºèÂª∫ÁØâÁöÑÁë∞ÂØ∂ÔºåÊ∞£Ê∞õËéäÂö¥„ÄÇ" },
                    { id: 203, lat: 42.8185, lng: -1.6443, name: "ÊΩòÊôÆÊ¥õÁ¥ç‰∏ªÊïôÂ†Ç", type: "sight", description: "ÊìÅÊúâË•øÁè≠ÁâôÊúÄÁæéËø¥Âªä‰πã‰∏ÄÁöÑÂì•Âæ∑ÂºèÊïôÂ†ÇÔºåÊòØÂ•îÁâõÁØÄÂüéÂ∏ÇÁöÑ‰∏≠ÂøÉ„ÄÇ" },
                    { id: 204, lat: 42.6719, lng: -1.8153, name: "ÁöáÂêéÊ©ã (Puente la Reina)", type: "sight", description: "ÊâÄÊúâÊúùËÅñ‰πãË∑ØÂåØÈõÜÊñºÊ≠§ÁöÑÁæÖÈ¶¨ÂºèÂè§Ê©ãÔºåÊòØÈÄôÊ¢ùË∑ØÁöÑÊ®ôË™åÊÄßÂª∫ÁØâ„ÄÇ" },
                    { id: 205, lat: 42.6713, lng: -2.0313, name: "ËÅñÂΩºÂæóÊïôÂ†Ç (San Pedro de la R√∫a)", type: "sight", description: "‰ΩçÊñºEstellaÔºåÊìÅÊúâÂ£ØËßÄÁöÑÁæÖÈ¶¨ÂºèËø¥ÂªäÂíåÈï∑ÈöéÊ¢Ø„ÄÇ" },
                    { id: 206, lat: 42.4394, lng: -2.9536, name: "ËÅñÂ§öÊòéÂì•Â§ßÊïôÂ†Ç", type: "sight", description: "ËëóÂêçÁöÑ„ÄåÈõûËàçÂ•áËπü„ÄçÁôºÁîüÂú∞ÔºåÊïôÂ†ÇÂÖßÁúüÁöÑÈ§äËëó‰∏ÄÂ∞çÊ¥ªÈõû„ÄÇ" },
                    { id: 207, lat: 42.3408, lng: -3.7028, name: "Â∏ÉÁàæÊààÊñØ‰∏ªÊïôÂ∫ßÂ†Ç", type: "sight", description: "Ë•øÁè≠ÁâôÂîØ‰∏ÄÁöÑÁç®Á´ã‰∏ñÁïåÈÅ∫Áî¢Â§ßÊïôÂ†ÇÔºåÂì•Âæ∑ÂºèÂª∫ÁØâÁöÑÂ∑îÂ≥∞‰πã‰Ωú„ÄÇ" },
                    { id: 208, lat: 42.2669, lng: -4.4056, name: "ËÅñÈ¶¨‰∏ÅÊïôÂ†Ç", type: "sight", description: "‰ΩçÊñºFr√≥mistaÔºåÊòØË•øÁè≠ÁâôÁæÖÈ¶¨ÂºèÂª∫ÁØâÊúÄÂÆåÁæéÁöÑÂÖ∏ÁØÑ‰πã‰∏Ä„ÄÇ" },
                    { id: 209, lat: 42.5987, lng: -5.5671, name: "ËêäÊòÇ‰∏ªÊïôÂ∫ßÂ†Ç", type: "sight", description: "‰ª•‰ª§‰∫∫È©öÂòÜÁöÑÂΩ©Áπ™ÁéªÁíÉÁ™óËÅûÂêçÊñº‰∏ñÔºåË¢´Á®±ÁÇ∫„ÄåÂÖâ‰πãÂ±ã„Äç„ÄÇ" },
                    { id: 210, lat: 42.4597, lng: -6.0567, name: "È´òÁ¨¨‰∏ªÊïôÂÆÆ", type: "sight", description: "È´òÁ¨¨Ë®≠Ë®àÁöÑÁèæ‰ª£‰∏ªÁæ©Âª∫ÁØâÔºåÂ§ñÂûãÂÉèÁ´•Ë©±ÂüéÂ†°ÔºåÁèæÁÇ∫ÊúùËÅñËÄÖÂçöÁâ©È§®„ÄÇ" },
                    { id: 211, lat: 42.4939, lng: -6.3356, name: "ÈêµÂçÅÂ≠óÊû∂ (Cruz de Ferro)", type: "sight", description: "ÊúùËÅñËÄÖÊúÉÂú®Ê≠§Êîæ‰∏ãÂæûÂÆ∂ÈÑâÂ∏∂‰æÜÁöÑÁü≥È†≠ÔºåË±°ÂæµÊîæ‰∏ãÂøÉ‰∏≠ÁöÑÈáçÊìî„ÄÇ" },
                    { id: 212, lat: 42.5466, lng: -6.5967, name: "ÈæêË≤ªÊãâÈÅîËÅñÊÆøÈ®éÂ£´ÂüéÂ†°", type: "sight", description: "‰øùÂ≠òÂÆåÂ•ΩÁöÑ‰∏≠‰∏ñÁ¥ÄËÅñÊÆøÈ®éÂ£´ÂúòÂüéÂ†°ÔºåË¶èÊ®°ÂÆèÂ§ß„ÄÇ" },
                    { id: 213, lat: 42.7064, lng: -7.0428, name: "O Cebreiro ËåÖËçâÂ±ã", type: "sight", description: "Âä†Âà©Ë•ø‰∫ûÂ±±ÂçÄÁâπÊúâÁöÑÂúìÂΩ¢ËåÖËçâÂ±ã (Pallozas)ÔºåÂΩ∑ÂΩøËµ∞ÈÄ≤Âè§‰ª£ÊùëËêΩ„ÄÇ" },
                    { id: 214, lat: 42.8805, lng: -8.5439, name: "ËÅñÂú∞ÁâôÂì•‰∏ªÊïôÂ∫ßÂ†Ç", type: "sight", description: "ÊúùËÅñ‰πãË∑ØÁöÑÁµÇÈªûÔºå‰ΩøÂæíËÅñÈõÖÂêÑÁöÑÂÆâÊÅØ‰πãÂú∞ÔºåÊâÄÊúâÊúùËÅñËÄÖÊóÖÁ®ãÁöÑÁõÆÊ®ô„ÄÇ" },

                    // --- Ë£úÂÖÖÊúçÂãôÈªû ---
                    { id: 2, lat: 42.8150, lng: -1.6400, name: "Casa Sabina", type: "food", description: "Êèê‰æõÊúùËÅñËÄÖÂ•óÈ§ê (Men√∫ del Peregrino) ‚Ç¨12„ÄÇ" },
                    { id: 3, lat: 42.8100, lng: -1.6500, name: "ÂÖ¨ÂÖ±È£≤Ê∞¥Ê≥â", type: "water", description: "ÂèØÈ£≤Áî®Ê∞¥ (Potable)„ÄÇ" }
                ];

                // Ë£ùÂÇôÊ∏ÖÂñÆ
                const packingList = ref({
                    "Êñá‰ª∂": [
                        { name: "ÊúùËÅñËÄÖË≠∑ÁÖß (Credencial)", checked: true, weight: 50 },
                        { name: "Ë≠∑ÁÖßËàáÂΩ±Êú¨", checked: true, weight: 50 },
                        { name: "‰øùÈö™Âç°/Ê≠êÁõüÂÅ•‰øùÂç°", checked: false, weight: 10 }
                    ],
                    "Ë°£Áâ©": [
                        { name: "Âø´‰πæÊéíÊ±óË°´ x2", checked: false, weight: 300 },
                        { name: "ÁôªÂ±±Ë§≤ (ÂèØÊãÜÂºè)", checked: false, weight: 400 },
                        { name: "ÁæäÊØõË•™ x3", checked: false, weight: 150 },
                        { name: "ËºïÈáèÈõ®Ë°£/ÊñóÁØ∑", checked: false, weight: 250 }
                    ],
                    "Ë£ùÂÇô": [
                        { name: "Áù°Ë¢ã (ËºïÈáè)", checked: false, weight: 800 },
                        { name: "ÁôªÂ±±Êùñ", checked: false, weight: 500 },
                        { name: "Âø´‰πæÊØõÂ∑æ", checked: false, weight: 100 }
                    ],
                    "ÂÄã‰∫∫Ë≠∑ÁêÜ": [
                        { name: "Âá°Â£´Êûó (Èò≤Á£®)", checked: false, weight: 50 },
                        { name: "ÈáùÁ∑öÂåÖ (ÊåëÊ∞¥Ê≥°)", checked: false, weight: 20 },
                        { name: "ËÄ≥Â°û (ÂøÖÂÇô!)", checked: true, weight: 5 }
                    ]
                });

                // Êñ∞Â¢ûÈ†ÖÁõÆÊö´Â≠òÂçÄ
                const newItemInput = ref({});
                for (const cat in packingList.value) {
                    newItemInput.value[cat] = { name: '', weight: null };
                }

                // Ë®àÁÆóÂ±¨ÊÄß
                // Á∏ΩÂÖ¨ÈáåÊï∏ÂåÖÂê´ËôõÊì¨ÁöÑÂ∑¥Â£´ÁßªÂãïË∑ùÈõ¢
                const totalKm = computed(() => stages.value.reduce((acc, s) => acc + s.km + (s.virtualKm || 0), 0));
                
                // ÂÆåÊàêÂÖ¨ÈáåÊï∏‰πüÂåÖÂê´ËôõÊì¨Ë∑ùÈõ¢
                const completedKm = computed(() => stages.value.filter(s => s.completed).reduce((acc, s) => acc + s.km + (s.virtualKm || 0), 0));
                
                const remainingKm = computed(() => (totalKm.value - completedKm.value).toFixed(1));
                const progressPercentage = computed(() => Math.round((completedKm.value / totalKm.value) * 100));
                
                // ËÉåÂåÖÁ∏ΩÈáçË®àÁÆó (ÂñÆ‰Ωç: kg)
                const totalWeight = computed(() => {
                    let w = 0;
                    for (const cat in packingList.value) {
                        packingList.value[cat].forEach(i => w += (Number(i.weight) || 0));
                    }
                    return (w / 1000).toFixed(2);
                });

                // ÂãïÊÖãÂèñÂæó‰∏ã‰∏ÄÁ´ôÊé®Ëñ¶‰ΩèÂÆø
                const nextRecommendedAlbergue = computed(() => {
                    // ÊâæÂá∫Á¨¨‰∏ÄÂÄãÂ∞öÊú™ÂÆåÊàêÁöÑÈöéÊÆµ
                    const nextStage = stages.value.find(s => !s.completed);
                    if (!nextStage || !nextStage.endAlbergue) return null;
                    
                    // Âú® POI ÂàóË°®‰∏≠Â∞ãÊâæÂåπÈÖçÁöÑÂ∫áË≠∑ÊâÄ
                    return pois.find(p => p.name === nextStage.endAlbergue);
                });

                const currentStageName = computed(() => {
                    const next = stages.value.find(s => !s.completed);
                    return next ? `ÂâçÂæÄ ${next.to}` : 'ÊÅ≠ÂñúÊäµÈÅî Santiago!';
                });
                
                // È†ê‰º∞Â§©Êï∏Âè™Ë®àÁÆóÂØ¶ÈöõÊ≠•Ë°åÁöÑÂâ©È§òÂ§©Êï∏ (ÊéíÈô§‰ºëÊÅØÊó•ËàáÂ∑¥Â£´)
                const estimatedDays = computed(() => {
                    const remainingTotal = stages.value.filter(s => !s.completed).length;
                    return remainingTotal;
                });

                // --- Ë≥áÊñôÊåÅ‰πÖÂåñ (localStorage) ---
                const STORAGE_KEY = 'camino-app-v1';

                const saveState = () => {
                    const state = {
                        // Âè™ÂÑ≤Â≠òÂÆåÊàêÁãÄÊÖãÔºåÈÅøÂÖçË¶ÜËìãË∑ØÊÆµÁöÑÈùúÊÖãË≥áË®ä
                        stageStatus: stages.value.map(s => s.completed),
                        // Ë£ùÂÇôÊ∏ÖÂñÆÂèØËÉΩÊúÉÊúâÊñ∞Â¢ûÈ†ÖÁõÆÔºåÊâÄ‰ª•Â≠òÊï¥ÂÄãÁâ©‰ª∂
                        packingList: packingList.value
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                };

                const loadState = () => {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            
                            // ÈÇÑÂéüË∑ØÊÆµÂÆåÊàêÁãÄÊÖã
                            if (parsed.stageStatus && Array.isArray(parsed.stageStatus)) {
                                parsed.stageStatus.forEach((status, idx) => {
                                    if (stages.value[idx]) {
                                        stages.value[idx].completed = status;
                                    }
                                });
                            }

                            // ÈÇÑÂéüË£ùÂÇôÊ∏ÖÂñÆ
                            if (parsed.packingList) {
                                packingList.value = parsed.packingList;
                            }
                        } catch (e) {
                            console.error("Error loading save:", e);
                        }
                    }
                };

                // ÊñπÊ≥ï
                const setView = (view) => {
                    currentView.value = view;
                    if (view === 'map') {
                        nextTick(() => {
                            initMap();
                            map.invalidateSize(); // Ëß£Ê±∫Âú∞ÂúñÂú® hidden ÂæåÂ§ßÂ∞èÈåØË™§ÂïèÈ°å
                            // Âº∑Âà∂ÈáçÊñ∞Ë®àÁÆóË∑ØÁ∑öÁØÑÂúç (Â¶ÇÊûúÂú∞ÂúñÂ∑≤Â≠òÂú®)
                            if (map) {
                                fitRoute();
                            }
                        });
                    }
                };
                
                // Ë®àÁÆó‰∏¶Á∏ÆÊîæËá≥Ë∑ØÁ∑öÁØÑÂúç
                const fitRoute = () => {
                    if (!map) return;
                    const routeCoordinates = [
                        [startPoint.lat, startPoint.lng], // Ëµ∑Èªû
                        ...stages.value.map(s => [s.lat, s.lng]) // ÂêÑË∑ØÊÆµÁµÇÈªû
                    ];
                    const bounds = L.latLngBounds(routeCoordinates);
                    map.fitBounds(bounds, { padding: [50, 50] });
                };

                // Ë∑≥ËΩâ‰∏¶ÂÆö‰ΩçÂà∞ÁâπÂÆöË∑ØÊÆµ
                const flyToStage = (index) => {
                    setView('map');
                    nextTick(() => {
                        const stage = stages.value[index];
                        if (map) {
                            map.flyTo([stage.lat, stage.lng], 13);
                            // È°ØÁ§∫ÊèêÁ§∫
                            showToast(`Â∑≤ÁßªÂãïËá≥: ${stage.to}`);
                        }
                    });
                };

                const showToast = (msg) => {
                    toastMsg.value = msg;
                    setTimeout(() => toastMsg.value = '', 2000);
                };

                const quickLog = () => {
                    showToast("Â∑≤Ë®òÈåÑÁõÆÂâç‰ΩçÁΩÆÔºÅ");
                };

                const toggleStage = (index) => {
                    stages.value[index].completed = !stages.value[index].completed;
                };

                const expandStage = (index) => {
                    expandedStageIndex.value = expandedStageIndex.value === index ? null : index;
                };

                const toggleItem = (cat, idx) => {
                    packingList.value[cat][idx].checked = !packingList.value[cat][idx].checked;
                };

                // --- Swipe Handlers ---
                const onSwipeStart = (e, category, index) => {
                    const id = `${category}-${index}`;
                    
                    if (swipeState.value.activeId && swipeState.value.activeId !== id) {
                        swipeState.value.activeId = null;
                        swipeState.value.isDragging = false;
                        return;
                    }

                    interactingId.value = id;
                    swipeState.value.startX = e.touches ? e.touches[0].clientX : e.clientX;
                    swipeState.value.startY = e.touches ? e.touches[0].clientY : e.clientY;
                    swipeState.value.isDragging = true;
                    
                    swipeState.value.baseOffset = (swipeState.value.activeId === id) ? -120 : 0;
                    swipeState.value.currentOffset = swipeState.value.baseOffset;
                    
                    isSwiping.value = false;
                };

                const onSwipeMove = (e) => {
                    if (!swipeState.value.isDragging || !interactingId.value) return;

                    const x = e.touches ? e.touches[0].clientX : e.clientX;
                    const y = e.touches ? e.touches[0].clientY : e.clientY;
                    const deltaX = x - swipeState.value.startX;
                    const deltaY = y - swipeState.value.startY;

                    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                        if (e.cancelable && e.type === 'touchmove') e.preventDefault();
                        isSwiping.value = true;
                        swipeState.value.activeId = interactingId.value;
                        
                        let newOffset = swipeState.value.baseOffset + deltaX;
                        swipeState.value.currentOffset = Math.min(0, Math.max(-140, newOffset));
                    }
                };

                const onSwipeEnd = (e) => {
                    if (!swipeState.value.isDragging || !interactingId.value) return;
                    
                    swipeState.value.isDragging = false;
                    
                    if (swipeState.value.currentOffset < -50) {
                        swipeState.value.activeId = interactingId.value;
                    } else {
                        swipeState.value.activeId = null;
                    }
                    
                    interactingId.value = null;
                };

                const getStyle = (category, index) => {
                    const id = `${category}-${index}`;
                    let x = 0;
                    
                    if (swipeState.value.activeId === id) {
                        if (swipeState.value.isDragging && interactingId.value === id) {
                            x = swipeState.value.currentOffset;
                        } else {
                            x = -120; // Open state
                        }
                    } else {
                        x = 0; // Closed state
                    }
                    
                    return { transform: `translateX(${x}px)` };
                };

                // Êñ∞Â¢ûÈ†ÖÁõÆÂäüËÉΩ
                const addItem = (category) => {
                    const input = newItemInput.value[category];
                    if (!input.name) return;
                    packingList.value[category].push({
                        name: input.name,
                        weight: input.weight ? Number(input.weight) : 0,
                        checked: false
                    });
                    input.name = '';
                    input.weight = null;
                };

                // ÈñãÂßãÁ∑®ËºØ
                const startEditing = (category, index) => {
                    const item = packingList.value[category][index];
                    editingState.value = { category, index };
                    editForm.value = { name: item.name, weight: item.weight || 0 };
                    swipeState.value.activeId = null;
                };

                // ÂÑ≤Â≠òÁ∑®ËºØ
                const saveEdit = (category, index) => {
                    if (!editForm.value.name) return;
                    const item = packingList.value[category][index];
                    item.name = editForm.value.name;
                    item.weight = Number(editForm.value.weight);
                    editingState.value = { category: null, index: null };
                };

                // Âà™Èô§È†ÖÁõÆÂäüËÉΩ
                const deleteItem = (category, index) => {
                    packingList.value[category].splice(index, 1);
                    swipeState.value.activeId = null; 
                };

                const showSyncStatus = () => {
                    showToast("Ë≥áÊñôÂ∑≤Ëá™ÂãïÂÑ≤Â≠ò");
                };

                const getPoiTypeLabel = (type) => {
                    const labels = { albergue: '‰ΩèÂÆø', food: 'È§êÈ£≤', water: 'Ê∞¥Ê∫ê', sight: 'ÊôØÈªû' };
                    return labels[type] || type;
                };

                const getFacilityName = (key) => {
                    const names = {
                        kitchen: "ÂªöÊàø",
                        laundry: "Ê¥óË°£Ê©ü",
                        wifi: "WiFi",
                        pool: "Ê≥≥Ê±†",
                        bar: "ÈÖíÂêß",
                        dinner: "‰æõÈ§ê",
                        garden: "Ëä±Âúí",
                        hot_water: "ÁÜ±Ê∞¥",
                        single_rooms: "ÂñÆ‰∫∫Êàø"
                    };
                    return names[key] || key;
                };

                const toggleMapFilter = (type) => {
                    filters.value[type] = !filters.value[type];
                    updateMapMarkers();
                };

                const getStagePois = (locationName) => {
                    if (!locationName) return [];
                    return pois.filter(p => p.type === 'albergue' && p.location === locationName);
                };

                const showPoiOnMap = (poi) => {
                    selectedPOI.value = poi;
                    setView('map');
                    nextTick(() => {
                        if (map) {
                            map.flyTo([poi.lat - 0.002, poi.lng], 16);
                        }
                    });
                };

                // Map Initialization
                let markers = [];
                const initMap = () => {
                    if (map) return;
                    
                    // ÂàùÂßãÂåñÂú∞Âúñ
                    map = L.map('map', { zoomControl: false });
                    
                    // ‰ΩøÁî® OpenStreetMap tiles (ÂØ¶ÈöõÈõ¢Á∑öÈúÄË¶Å cache Ê©üÂà∂)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OSM',
                        maxZoom: 19
                    }).addTo(map);

                    // --- Áπ™Ë£ΩË∑ØÁ∑ö (Polyline) ---
                    // ÁµÑÂêàÊâÄÊúâÂ∫ßÊ®ôÈªûÔºöËµ∑Èªû + ÂêÑÈöéÊÆµÁµÇÈªû
                    const routeCoordinates = [
                        [startPoint.lat, startPoint.lng], // Ëµ∑Èªû
                        ...stages.value.map(s => [s.lat, s.lng]) // ÂêÑË∑ØÊÆµÁµÇÈªû
                    ];

                    // Áπ™Ë£ΩÈªÉËâ≤ÁÆ≠È†≠Ë∑ØÂæë
                    L.polyline(routeCoordinates, { 
                        color: '#f59e0b', // Camino Yellow
                        weight: 5, 
                        opacity: 0.8,
                        lineCap: 'round'
                    }).addTo(map);

                    // Âú®ÊØèÂÄãË∑ØÊÆµÁµÇÈªûÂä†‰∏äÂ∞èÂúìÈªûÊ®ôË®ò (Ë¶ñË¶∫ÂåñË∑ØÊÆµ)
                    routeCoordinates.forEach((coord, index) => {
                        L.circleMarker(coord, {
                            radius: 4,
                            fillColor: 'white',
                            color: '#f59e0b',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 1
                        }).addTo(map);
                    });

                    // POI Icons
                    updateMapMarkers();

                    // Ëá™ÂãïÁ∏ÆÊîæÂú∞Âúñ‰ª•È°ØÁ§∫Êï¥Ê¢ùË∑ØÁ∑ö
                    fitRoute();
                };

                const updateMapMarkers = () => {
                    // Ê∏ÖÈô§ËàäÊ®ôË®ò
                    markers.forEach(m => map.removeLayer(m));
                    markers = [];

                    pois.forEach(poi => {
                        if (!filters.value[poi.type]) return;

                        let iconClass = '';
                        let colorClass = '';
                        
                        if (poi.type === 'albergue') { iconClass = 'fa-bed'; colorClass = 'text-blue-600'; }
                        else if (poi.type === 'sight') { iconClass = 'fa-camera'; colorClass = 'text-purple-600'; }
                        else if (poi.type === 'food') { iconClass = 'fa-utensils'; colorClass = 'text-green-600'; }
                        else if (poi.type === 'water') { iconClass = 'fa-faucet'; colorClass = 'text-blue-400'; }

                        const customIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div class="bg-white rounded-full w-8 h-8 flex items-center justify-center shadow-md border-2 border-white ${colorClass}"><i class="fa-solid ${iconClass}"></i></div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        });

                        const marker = L.marker([poi.lat, poi.lng], { icon: customIcon }).addTo(map);
                        marker.on('click', () => {
                            selectedPOI.value = poi;
                            // Â∞áÂú∞Âúñ‰∏≠ÂøÉÁßªÂà∞ POI ‰∏¶Á®çÂæÆÂêë‰∏ãÂÅèÁßª‰ª•ÁïôÁ©∫ÈñìÁµ¶Âç°Áâá
                            map.flyTo([poi.lat - 0.002, poi.lng], 16);
                        });
                        markers.push(marker);
                    });
                };

                const locateUser = () => {
                    if (!navigator.geolocation) {
                        showToast("ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂÆö‰Ωç");
                        return;
                    }
                    showToast("Ê≠£Âú®ÂÆö‰Ωç...");
                    navigator.geolocation.getCurrentPosition((pos) => {
                        const { latitude, longitude } = pos.coords;
                        if (userMarker) map.removeLayer(userMarker);
                        
                        // ËóçËâ≤ÂúìÈªû
                        const userIcon = L.divIcon({
                            className: 'user-location-icon',
                            html: '<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-lg animate-pulse"></div>',
                            iconSize: [16, 16]
                        });

                        userMarker = L.marker([latitude, longitude], { icon: userIcon }).addTo(map);
                        map.flyTo([latitude, longitude], 15);
                    }, (err) => {
                        showToast("ÂÆö‰ΩçÂ§±Êïó: " + err.message);
                        // Fallback Ê®°Êì¨ (ÂõûÂà∞Ëµ∑Èªû)
                        map.flyTo([startPoint.lat, startPoint.lng], 15);
                    });
                };

                const downloadOfflineMap = () => {
                    showToast("Ê≠£Âú®‰∏ãËºâÊ≠§ÂçÄÂüüÂúñË≥á...");
                    setTimeout(() => showToast("‰∏ãËºâÂÆåÊàê (Ê®°Êì¨)"), 1500);
                };

                // ÁîüÂëΩÈÄ±Êúü
                onMounted(() => {
                    loadState(); // ÂÖàËÆÄÂèñÂ≠òÊ™î
                    initMap();
                });

                // Áõ£ËÅΩÂô® - Ëá™ÂãïÂ≠òÊ™î
                watch(stages, () => saveState(), { deep: true });
                watch(packingList, () => saveState(), { deep: true });

                return {
                    currentView,
                    stages,
                    packingList,
                    guideTab,
                    toastMsg,
                    expandedStageIndex,
                    selectedPOI,
                    filters,
                    // Computed
                    totalKm,
                    completedKm,
                    remainingKm,
                    progressPercentage,
                    currentStageName,
                    estimatedDays,
                    nextRecommendedAlbergue,
                    // Methods
                    setView,
                    quickLog,
                    toggleStage,
                    expandStage,
                    toggleItem,
                    addItem, 
                    deleteItem,
                    startEditing, 
                    saveEdit,     
                    editingState, 
                    editForm,     
                    totalWeight, 
                    newItemInput, 
                    showSyncStatus,
                    locateUser,
                    downloadOfflineMap,
                    getPoiTypeLabel,
                    toggleMapFilter,
                    getFacilityName,
                    flyToStage,
                    getStagePois,
                    showPoiOnMap,
                    hourlyForecast, 
                    clothingAdvice, 
                    isWeatherExpanded,
                    fitRoute, // Êñ∞Â¢ûÁöÑÂáΩÂºè
                    // Swipe
                    handleTouchStart: onSwipeStart,
                    handleTouchMove: onSwipeMove,
                    handleTouchEnd: onSwipeEnd,
                    getSwipeStyle: getStyle,
                    isSwiping
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
